!function(e){wcpoa.fields.repeater=wcpoa.field.extend({type:"repeater",$el:null,$input:null,$table:null,$tbody:null,$clone:null,actions:{ready:"initialize",append:"initialize",show:"show"},events:{'click a[data-event="add-row"]':"_add",'click a[data-event="remove-row"]':"_remove",'click a[data-event="collapse-row"]':"_collapse","mouseenter td.order":"_mouseenter"},focus:function(){this.$el=this.$field.find(".wcpoa-repeater:first"),this.$input=this.$field.find("input:first"),this.$table=this.$field.find("table:first"),this.$tbody=this.$table.children("tbody"),this.$clone=this.$tbody.children("tr.wcpoa-clone"),this.o=wcpoa.get_data(this.$el,{min:0,max:0}),this.o.min=parseInt(this.o.min),this.o.max=parseInt(this.o.max)},initialize:function(){wcpoa.disable_form(this.$clone,"repeater"),this.render()},show:function(){this.$tbody.find(".wcpoa-field:visible").each(function(){wcpoa.do_action("show_field",e(this))})},count:function(){return this.$tbody.children().length-1},render:function(){this.$tbody.children().each(function(t){e(this).find("> td.order > span").html(t+1)}),0==this.count()?this.$el.addClass("-empty"):this.$el.removeClass("-empty"),this.o.max>0&&this.count()>=this.o.max?this.$el.find("> .wcpoa-actions .button").addClass("disabled"):this.$el.find("> .wcpoa-actions .button").removeClass("disabled")},add:function(e){if(e=e||this.$clone,this.o.max>0&&this.count()>=this.o.max)return alert(wcpoa._e("repeater","max").replace("{max}",this.o.max)),!1;var t=this.$field;return $el=wcpoa.duplicate(this.$clone),$el.removeClass("wcpoa-clone"),$el.addClass("wcpoa-has-value"),wcpoa.enable_form($el,"repeater"),e.before($el),this.doFocus(t),this.render(),wcpoa.validation.remove_error(this.$field),this.sync(),$el},remove:function(e){var t=this;if(this.count()<=this.o.min)return alert(wcpoa._e("repeater","min").replace("{min}",this.o.min)),!1;wcpoa.do_action("remove",e),wcpoa.remove_tr(e,function(){t.$input.trigger("change"),t.render(),t.sync(),wcpoa.do_action("refresh",t.$field)})},sync:function(){var t="collapsed_"+this.$field.data("key"),o=[];this.$tbody.children().each(function(t){e(this).hasClass("-collapsed")&&o.push(t)}),wcpoa.update_user_setting(t,o.join(","))},_mouseenter:function(e){if(!this.$tbody.hasClass("ui-sortable")&&1!=this.o.max){var t=this;this.$tbody.sortable({items:"> tr",handle:"> td.order",forceHelperSize:!0,forcePlaceholderSize:!0,scroll:!0,start:function(e,t){wcpoa.do_action("sortstart",t.item,t.placeholder)},stop:function(e,o){t.render(),wcpoa.do_action("sortstop",o.item,o.placeholder)},update:function(e,o){t.$input.trigger("change")}})}},_add:function(e){$row=!1,e.$el.hasClass("wcpoa-icon")&&($row=e.$el.closest(".wcpoa-row")),this.add($row)},_remove:function(e){var t=this,o=e.$el.closest(".wcpoa-row");o.addClass("-hover"),wcpoa.tooltip.confirm_remove(e.$el,function(e){o.removeClass("-hover"),e&&t.remove(o)})},_collapse:function(e){var t=e.$el.closest(".wcpoa-row"),o=this.$field;t.hasClass("-collapsed")?(t.removeClass("-collapsed"),wcpoa.do_action("show",t,"collapse")):(t.addClass("-collapsed"),wcpoa.do_action("hide",t,"collapse")),this.set("$field",o).sync(),wcpoa.do_action("refresh",this.$field)}})}(jQuery);